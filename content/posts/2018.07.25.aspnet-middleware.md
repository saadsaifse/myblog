---
date: 2017-12-28
title: "4 Types of ASP.NET Middleware"
template: post
slug: 4-types-of-aspnet-middleware
categories:
  - APIs
tags:
  - ASP.NET
  - API
  - Middleware
  - SOA
---

## Middleware

In ASP.NET core, middleware is a term used for components that are assembled in to the application pipeline to handle requests and responses. These middleware components are arranged like a chain, and whenever a new request arrives, it orderly passes through all assembled components in the chain. Each middleware usually contains reference to the next middleware in the form of Request Delegate, that it calls after executing its own logic. Once a request has been handled, the response that will be returned to the client is passed back along the chain, which allows all of the earlier components to inspect or modify it.

## Middleware Format

Middleware can be written as an anonymous method in `IApplicationbuilder`â€™s Run, Use or Map extension methods but you can also define a simple class which does not inherit from any base class neither implement any required interface. The only requirement is that, it should provide a method named Invoke or InvokeAsync. You can see the format of sample middleware below:

```csharp
public class SampleMiddleware
{
  private RequestDelegate nextDelegate;
  public SampleMiddleware(RequestDelegate next) => nextDelegate = next;

  public async Task InvokeAsync(HttpContext httpContext)
  {
    // Do work that doesn't write to the Response.

    // Call the next delegate/middleware in the pipeline
    await nextDelegate(httpContext);

    // Do logging or other work that doesn't write to the Response.
  }
}
```

## Types of Middleware

There are about 4 types of middleware that you will encounter.

### Content Generating Middleware

The most important type of middleware generates content for clients, and it is this category to which MVC belongs.

```csharp
public class ContentMiddleware
{
  private RequestDelegate nextDelegate;
  public ContentMiddleware(RequestDelegate next) => nextDelegate = next;
  public async Task InvokeAsync(HttpContext httpContext)
  {
   if (httpContext.Request.Path.ToString().ToLower() == "/content")
   {
     await httpContext.Response.WriteAsync("Hello from the content middleware", Encoding.UTF8);
   }
   else
   {
     await nextDelegate.Invoke(httpContext);
   }
  }
}
```

### Short-Circuiting Middleware

This type of middleware short-circuit i.e. return the response if some criteria is met, else they call the next delegate. They are often used for performance purposes.

```csharp
public class ShortCircuitMiddleware
{
  private RequestDelegate nextDelegate;
  public ShortCircuitMiddleware(RequestDelegate next) => nextDelegate = next;
  public async Task Invoke(HttpContext httpContext)
  {
    if (httpContext.Request.Headers["User-Agent"].Any(h => h.ToLower().Contains("edge")))
    {
      httpContext.Response.StatusCode = 403;
    }
    else
    {
      await nextDelegate.Invoke(httpContext);
    }
  }
}
```

### Request Editing Middleware

Any middleware that does not generate a response. Instead, it edits the incoming request and then calls the next middleware in the chain.

```csharp
public class RequestEditingMiddleware
{
  private RequestDelegate nextDelegate;
  public RequestEditingMiddleware(RequestDelegate next) => nextDelegate = next;
  public async Task Invoke(HttpContext httpContext)
  {
    httpContext.Items["EdgeBrowser"] = httpContext.Request.Headers["User-Agent"].Any(v => v.ToLower().Contains("edge"));
    await nextDelegate.Invoke(httpContext);
  }
}
```

### Response-Editing Middleware

The final type of middleware operates on the responses generated by other components in the pipeline. This is useful for logging details of requests and their responses or for dealing with errors.

```csharp
public class ResponseEditingMiddleware
{
  private RequestDelegate nextDelegate;
  public ResponseEditingMiddleware(RequestDelegate next) => nextDelegate = next;
  public async Task InvokeAsync(HttpContext httpContext)
  {
    await nextDelegate.Invoke(httpContext);
    if (httpContext.Response.StatusCode == 403)
    {
      await httpContext.Response.WriteAsync("Edge not supported", Encoding.UTF8);
    }
    else if (httpContext.Response.StatusCode == 404)
    {
      await httpContext.Response.WriteAsync("No content middleware response", Encoding.UTF8);
    }
  }
}
```
